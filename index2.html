<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SOS</title>

<style>
body{
  margin:0; font-family: system-ui, Arial;
  background:#020617; color:#fff;
  display:flex; justify-content:center; align-items:center;
  min-height:100vh;
}

.wrap{
  width:100%; max-width:360px; padding:16px;
}

.card{
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:18px;
  padding:16px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
}

h1{ margin:0 0 10px; }

.display{
  font-size:34px;
  font-weight:900;
  letter-spacing:6px;
  margin:10px 0;
}

.dot{
  width:14px; height:14px; border-radius:50%;
  margin:8px auto;
  background:#ef4444;
  box-shadow:0 0 12px rgba(239,68,68,.8);
}

.dot.orange{ background:#f59e0b; box-shadow:0 0 12px rgba(245,158,11,.9);}
.dot.green{ background:#22c55e; box-shadow:0 0 14px rgba(34,197,94,1);}

.next{
  font-size:25px; opacity:.85; margin-top:6px;
}

.pad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:14px;

  transform: rotate(180deg);
}

.pad button{
  transform: rotate(180deg);
}


.pad button{
  padding:16px;
  font-size:20px;
  font-weight:900;
  border:0;
  border-radius:14px;
  background:#1e293b;
  color:#fff;
}

.pad button:active{ transform:scale(.95); }

.actions{
  display:flex; gap:10px; margin-top:12px;
}

.actions button{
  flex:1; padding:12px; border:0; border-radius:14px;
  font-weight:900; font-size:16px;
}

.clear{ background:#64748b; color:#020617;}
.back{ background:#ef4444; color:#220000;}

.timer{
  margin:20px auto;
  padding:8px 12px;
  width:80%;
  text-align:center;
display: flex;


  font-size:18px;
  font-weight:800;
  letter-spacing:1.5px;
gap:10px;
  color:#facc15; /* ×¦×”×•×‘ */

  background:rgba(250,204,21,0.08);
  border:1px solid rgba(250,204,21,0.35);
  border-radius:12px;

  box-shadow:0 0 12px rgba(250,204,21,0.25);
}

/* ===== EXIT CONFIRM MODAL ===== */

.confirmBg{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,0.85);
  backdrop-filter: blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.confirmCard{
  background:linear-gradient(180deg,#020617,#020617ee);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:22px;
  padding:20px 18px 22px;
  width:90%;
  max-width:320px;
  text-align:center;
  box-shadow:
    0 20px 60px rgba(0,0,0,0.8),
    inset 0 0 0 1px rgba(255,255,255,0.05);
  animation: popIn .25s ease-out;
}

@keyframes popIn{
  from{ transform:scale(.9); opacity:0; }
  to{ transform:scale(1); opacity:1; }
}

.confirmCard b{
  color:#facc15;
}

.confirmBtns{
  display:flex;
  gap:12px;
  margin-top:16px;
}

.confirmBtns button{
  flex:1;
  border:0;
  border-radius:14px;
  padding:12px 0;
  font-size:15px;
  font-weight:900;
  cursor:pointer;
}

.confirmBtns .exit{
  background:linear-gradient(135deg,#ef4444,#dc2626);
  color:#220000;
  box-shadow:0 6px 20px rgba(239,68,68,.45);
}

.confirmBtns .stay{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#04210f;
  box-shadow:0 6px 20px rgba(34,197,94,.45);
}

</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸš¨ ××¦×‘ SOS</h1>
    
    <div class="display" id="display">â€” â€” â€”</div>

    <div class="dot" id="dot"></div>

    <div class="next" id="next">×”×‘× ×‘×ª×•×¨: 1,1,1</div>

    <div class="pad" id="pad"></div>
<div class="timer"> ×–××Ÿ ×‘××¦×‘  SOS:  <span id="sosTime">00:00</span>
</div>
    <div class="actions">
      <button class="back" onclick="goBack()">×—×–×¨×”</button>
    </div>
  </div>
</div>

<!-- ===== EXIT CONFIRM MODAL ===== -->
<div id="exitBox" class="confirmBg" style="display:none;">
  <div class="confirmCard">

    <div style="font-size:20px;font-weight:900;margin-bottom:8px;">
      ×œ×¦××ª ×××¦×‘ SOS?
    </div>

    <div style="font-size:14px;opacity:.8;line-height:1.5;">
      ×”×ª×”×œ×™×š ×™×™×¤×¡×§ ×•×ª×—×–×•×¨ ×œ××¡×š ×”×¨××©×™.<br>
      ×”×˜×™×™××¨ ×‘×›×¡×¤×ª <b>×œ× ×™×ª××¤×¡</b>.
    </div>

    <div class="confirmBtns">
      <button class="exit" onclick="confirmExit()">×›×Ÿ, ×œ×¦××ª</button>
      <button class="stay" onclick="closeExit()">×œ×”×™×©××¨</button>
    </div>

  </div>
</div>

<script>

const SB_URL = "https://xjtkgravwxhdhvrijjft.supabase.co";
const API_KEY = "sb_publishable_Q3Y43jrRDl3LYpT5iPsCgw_88J7c1kZ";

async function send(cmd, value){
  try{
    await fetch(SB_URL + "/rest/v1/esp_cmd?id=eq.1", {
      method: "PATCH",
      headers: {
        apikey: API_KEY,
        Authorization: "Bearer " + API_KEY,
        "Content-Type": "application/json",
        "Prefer": "return=minimal"
      },
      body: JSON.stringify({
        cmd: cmd,
        value: value,
        updated_at: new Date().toISOString()
      })
    });
  }catch(e){
    console.log("SEND FAIL", e);
  }
}


  let sosStart = Date.now();

setInterval(()=>{
  const sec = Math.floor((Date.now() - sosStart)/1000);
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  sosTime.textContent = m + ":" + s;
},1000);


/* ===== CONFIG ===== */
const MAX = 12;                 // 1..12
const TOTAL = MAX*MAX*MAX;      // 1728

/* ===== STATE ===== */
let input = [];
let tried = new Set();
let expectedIndex = 0;
let secretIndex = calcIndex(1,1,1); // ×ª××™×“ ×”×§×•×“ ×™×”×™×” 1,1,1
let unlocked = false; 

console.log("SECRET:", secretIndex); // ×¨×§ ×œ×¤×™×ª×•×— ğŸ˜…

/* ===== HELPERS ===== */
function calcIndex(a,b,c){
  return (a-1)*144 + (b-1)*12 + (c-1);
}

function indexToCombo(i){
  const a = Math.floor(i / 144) + 1;
  const b = Math.floor((i % 144) / 12) + 1;
  const c = (i % 12) + 1;
  return [a,b,c];
}

function updateNext(){
  while(tried.has(expectedIndex) && expectedIndex < TOTAL){
    expectedIndex++;
  }
  if(expectedIndex >= TOTAL){
    next.textContent = "× ×’××¨×• ×›×œ ×”××¤×©×¨×•×™×•×ª";
    return;
  }
  const [a,b,c] = indexToCombo(expectedIndex);
  next.textContent = `×”×‘× ×‘×ª×•×¨: ${a},${b},${c}`;
}

function setDot(color){
  dot.className = "dot";
  if(color) dot.classList.add(color);
}

function press(n){
  if(unlocked) return;   // â›” ×—×•×¡× ×”×›×œ ××—×¨×™ ×”×¦×œ×—×”
  if(input.length >= 3) return;

  input.push(n);
  renderInput();

  if(input.length === 3){
    checkCombo();
  }
}


function renderInput(){
  display.textContent = input.length ? input.join(" ") : "â€” â€” â€”";
}

function clearInput(){
  input = [];
  renderInput();
}

/* ===== LOGIC ===== */
function checkCombo(){
  const [a,b,c] = input;
  const idx = calcIndex(a,b,c);
  tried.add(idx);

 if(idx === secretIndex){
  unlocked = true;
  setDot("green");
  display.textContent = "× ×¤×ª×— âœ”";

  send("reset", 1); // ğŸ”¥ ×××¤×¡ ×˜×™×™××¨ ×‘×›×¡×¤×ª ×“×¨×š Supabase

  setTimeout(()=>location.href="index.html", 3000);
  return;
}


  if(idx === expectedIndex){
    setDot(); // ××“×•×
  }else{
    setDot("orange");
  }

  updateNext();

  setTimeout(()=>{
    clearInput();
  },400);
}

/* ===== UI BUILD ===== */
for(let i=1;i<=MAX;i++){
  const b=document.createElement("button");
  b.textContent=i;
  b.onclick=()=>press(i);
  pad.appendChild(b);
}

function goBack(){
  exitBox.style.display = "flex";
  document.querySelector('.wrap').style.pointerEvents = 'none';
}

function closeExit(){
  exitBox.style.display = "none";
  document.querySelector('.wrap').style.pointerEvents = 'auto';
}

function confirmExit(){
  location.href = "index.html";
}


updateNext();
</script>
</body>
</html>
